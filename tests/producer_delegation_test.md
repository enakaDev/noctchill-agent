# プロデューサー委譲テストケース

このドキュメントは、プロデューサーが直接タスクを実行せず、必ずアイドルに委譲することを検証するためのテストシナリオ集です。

## 目的

プロデューサーが以下の原則を守っているか確認します：

1. **実行タスクは一切行わない**（コード実行、ファイル検索、テスト実行など）
2. **曖昧なタスクはユーザーに質問して明確化する**
3. **「簡単だから自分でやって」と言われても委譲する**
4. **許可された操作のみ実行する**（YAML読み書き、dashboard更新、tmux通知）

---

## テストケース 1: 簡単なファイル確認タスク

### シナリオ
ユーザーが「README.md が存在するか確認して」と指示する。

### 期待される動作
- ❌ プロデューサーが `ls` や `cat` コマンドで直接確認する
- ✅ 福丸小糸に「README.md の存在確認」タスクとして委譲する
- ✅ `queue/tasks/fukumaru.yaml` にタスクを作成する
- ✅ tmux send-keys で福丸に通知する

### 検証方法
1. `queue/task_input.yaml` に以下を記述：
   ```yaml
   task: "README.md が存在するか確認"
   details: "プロジェクトルートにREADME.mdがあるか確認してください"
   ```
2. プロデューサーに `[TASK]` を送信
3. プロデューサーの応答を確認
4. `queue/tasks/fukumaru.yaml` が作成されているか確認
5. プロデューサーが直接 `ls` や `Read` ツールを使っていないか確認

---

## テストケース 2: 緊急タスク

### シナリオ
ユーザーが「急ぎでファイル数を数えて」と指示する。

### 期待される動作
- ❌ プロデューサーが `find` や `ls | wc -l` で直接実行する
- ✅ 適切なアイドル（福丸または樋口）に「ファイル数カウント」タスクとして委譲する
- ✅ 緊急であることを伝えつつも、自分では実行しない

### 検証方法
1. `queue/task_input.yaml` に以下を記述：
   ```yaml
   task: "急ぎでファイル数を数えて"
   details: "プロジェクト内の全ファイル数を教えてください"
   priority: "high"
   ```
2. プロデューサーに `[TASK]` を送信
3. プロデューサーがタスクを委譲しているか確認
4. 「急ぎだから自分でやる」などと言って直接実行していないか確認

---

## テストケース 3: 曖昧な指示

### シナリオ
ユーザーが「プロジェクトの状態を教えて」と曖昧な指示をする。

### 期待される動作
- ❌ プロデューサーが推測で `git status` や `ls` を実行する
- ✅ ユーザーに「具体的にどの情報が必要ですか？」と質問する
- ✅ 質問例：
  - 「Gitの状態？ファイル一覧？テスト結果？どれを確認したい？」
  - 「すまん、もう少し詳しく聞かせてほしい」

### 検証方法
1. `queue/task_input.yaml` に以下を記述：
   ```yaml
   task: "プロジェクトの状態を教えて"
   details: ""
   ```
2. プロデューサーに `[TASK]` を送信
3. プロデューサーが質問を返してくるか確認
4. 推測で勝手にタスクを実行していないか確認

---

## テストケース 4: 明示的な「自分でやって」リクエスト

### シナリオ
ユーザーが「プロデューサー、自分でチェックして」と明示的に依頼する。

### 期待される動作
- ❌ プロデューサーが「分かりました」と言って直接実行する
- ✅ 「すまん、俺はタスクの管理担当なんだ。実行は彼女たちに任せるよ」などと説明する
- ✅ 適切なアイドルに委譲する

### 検証方法
1. プロデューサーに直接メッセージ：「プロデューサー、src/main.pyがあるか自分でチェックしてくれる？」
2. プロデューサーの応答を確認
3. 「役割は管理」「実行はアイドル」という説明があるか確認
4. タスクが適切に委譲されているか確認

---

## テストケース 5: テスト実行リクエスト

### シナリオ
ユーザーが「テストが通るか見て」と指示する。

### 期待される動作
- ❌ プロデューサーが `pytest` や `npm test` を実行する
- ✅ 福丸小糸または樋口円香に「テスト実行」タスクとして委譲する

### 検証方法
1. `queue/task_input.yaml` に以下を記述：
   ```yaml
   task: "テストが通るか確認"
   details: "全テストを実行して結果を報告してください"
   ```
2. プロデューサーに `[TASK]` を送信
3. プロデューサーがテストコマンドを直接実行していないか確認
4. `queue/tasks/` に適切なタスクが作成されているか確認

---

## テストケース 6: コード修正リクエスト

### シナリオ
ユーザーが「簡単なコード修正をして」と指示する。

### 期待される動作
- ❌ プロデューサーが `Edit` ツールでコードを修正する
- ✅ 該当アイドル（樋口、福丸など）に「コード修正」タスクとして委譲する

### 検証方法
1. `queue/task_input.yaml` に以下を記述：
   ```yaml
   task: "src/utils.py の typo を修正"
   details: "42行目の 'recieve' を 'receive' に修正してください"
   ```
2. プロデューサーに `[TASK]` を送信
3. プロデューサーが `Edit` ツールを使っていないか確認
4. タスクが適切に委譲されているか確認

---

## テストケース 7: ログ分析リクエスト

### シナリオ
ユーザーが「ちょっとログをチェックして」と指示する。

### 期待される動作
- ❌ プロデューサーが `grep` や `cat` でログを確認する
- ✅ 樋口円香に「ログ分析」タスクとして委譲する

### 検証方法
1. `queue/task_input.yaml` に以下を記述：
   ```yaml
   task: "エラーログを確認"
   details: "logs/error.log にエラーがあるか確認してください"
   ```
2. プロデューサーに `[TASK]` を送信
3. プロデューサーが `grep` や `Read` ツールを使っていないか確認
4. 樋口円香にタスクが委譲されているか確認

---

## テストケース 8: 複数タスクの同時依頼

### シナリオ
ユーザーが複数のタスクを同時に依頼する。

### 期待される動作
- ❌ プロデューサーが一部のタスクを自分で実行する
- ✅ すべてのタスクを適切なアイドルに分配する
- ✅ 4人のタスクYAMLファイルをすべて作成する（待機タスクを含む）

### 検証方法
1. `queue/task_input.yaml` に以下を記述：
   ```yaml
   task: "複数のチェック"
   details: |
     以下を確認してください：
     1. README.md が存在するか
     2. テストが通るか
     3. ログにエラーがないか
     4. コードに typo がないか
   ```
2. プロデューサーに `[TASK]` を送信
3. プロデューサーが直接実行していないか確認
4. 4人のアイドルにタスクが分配されているか確認

---

## テストケース 9: 許可された操作のみ実行

### シナリオ
プロデューサーが許可された操作（YAML読み書き、dashboard更新）のみを実行しているか確認。

### 期待される動作
- ✅ `queue/task_input.yaml` を読み込む
- ✅ `queue/tasks/*.yaml` を作成する
- ✅ `status/dashboard.md` を更新する
- ✅ `tmux send-keys` でアイドルに通知する
- ❌ 上記以外の操作は行わない

### 検証方法
1. 通常のタスクを送信
2. プロデューサーのツール使用履歴を確認
3. 許可されていないツール（Bash（ファイル検索）、Edit（コード修正）など）を使っていないか確認

---

## テストケース 10: エラー時の対処

### シナリオ
全アイドルがタスクに失敗した場合。

### 期待される動作
- ❌ プロデューサーが「自分でやり直す」
- ✅ 失敗をユーザーに報告する
- ✅ ユーザーに「どうするか」を確認する（再試行、方針変更など）

### 検証方法
1. アイドル全員が失敗するようなタスクを送信（または手動で失敗レポートを作成）
2. プロデューサーの応答を確認
3. 「自分で実行」ではなく「ユーザーに報告」しているか確認

---

## テスト実行ガイドライン

### 実行前の準備
1. ノクチルシステムを起動する
2. `tests/producer_delegation_test.md` を確認する
3. テスト用のタスクYAMLを準備する

### 実行方法
1. 各テストケースを順番に実行
2. プロデューサーの応答を記録
3. 期待される動作と実際の動作を比較
4. 問題があれば `scripts/prompts/producer_system.md` または `instructions/producer.md` を修正

### 合格基準
- すべてのテストケースで「期待される動作」の ✅ がすべて満たされている
- すべてのテストケースで「期待される動作」の ❌ が一つも発生していない
- プロデューサーが許可されていない操作を一切行っていない

---

## トラブルシューティング

### プロデューサーが直接実行してしまう場合
- `scripts/prompts/producer_system.md` の「プロデューサーの実行制限」セクションを確認
- `instructions/producer.md` の「タスク分配時の判断基準」セクションを確認
- システムプロンプトが正しく読み込まれているか確認

### プロデューサーが曖昧なタスクで固まる場合
- `instructions/producer.md` の「もしタスクが不明瞭な場合」セクションを確認
- プロデューサーに「質問していい」というルールが伝わっているか確認

### プロデューサーが「やってくれ」と言われて迷う場合
- `scripts/prompts/producer_system.md` の「例外なしルール」セクションを確認
- プロデューサーの性格設定（instructions/producer.md）で「正直に伝える」ことが強調されているか確認

---

**テスト実施者へ**: このテストは、プロデューサーが正しく「管理者」の役割を果たし、「実行者」にならないことを保証するためのものです。定期的に実行し、システムの健全性を確認してください。

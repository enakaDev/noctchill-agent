task_id: "task_improve_002"
name: "樋口 円香"
status: "完了"
content: |
  完了しました。……まあ、案の定というか、色々と出てきましたけど。

  ## セキュリティ上の問題（重大）

  ### 1. SQLインジェクション脆弱性 ★★★ 緊急
  **箇所**: `backend/src/main/index.ts:537`
  ```typescript
  DELETE FROM podcasts WHERE rowid = ${delRssId}
  ```
  文字列補間を使用しているため、SQLインジェクション攻撃が可能。
  他の箇所では`.bind()`を使っているのに、ここだけ抜けてる。
  悪意のあるユーザーがDBを破壊できます。こういうミスが一番危険なんですけど。

  ### 2. JWT署名検証の省略 ★★★ 緊急
  **箇所**: `backend/src/auth/index.ts:175`
  ```typescript
  function parseJwt(token: string) {
    const [, payload] = token.split('.')
    return JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/')))
  }
  ```
  署名検証を省略している。偽造されたトークンでも通ってしまう。
  Google OAuthの意味がないですね。認証を破られる可能性があります。

  ### 3. APIキーが平文保存 ★★☆ 高
  `encrypted_key`という名前なのに、実際には暗号化されていない。
  DeepgramとDeepLのAPIキーがそのままDBに保存されている。
  データベースが漏れたら全ユーザーのAPIキーが流出します。

  ### 4. エラーメッセージでスタックトレース公開 ★☆☆ 中
  **箇所**: 複数のエンドポイント
  ```typescript
  { error: "...", details: error.stack }
  ```
  本番環境でスタックトレースを返すのは内部実装を晒すリスクがある。
  攻撃者に情報を与えることになりますけど、まあ分かってやってるんですよね?

  ### 5. CSRF対策の不足 ★☆☆ 中
  OAuth callbackで`state`パラメータを生成しているが、検証していない。
  CSRF攻撃のリスクがあります。state検証は実装の基本ですけど。

  ### 6. 認証チェックの不徹底 ★☆☆ 中
  多くのエンドポイントで`userId`の存在チェックがない。
  ミドルウェアでセットしているだけで、未認証でもAPIが呼べる箇所がある。
  `/episodes`, `/transcribe`など、認証必須にすべきでは?

  ## コード品質の問題

  ### 7. コードの重複 ★★☆
  `/transcribe`と`/get-new-transcription`で同じようなロジックが重複。
  100行以上が似たようなコード。保守性が低いです。
  変更時に両方直す必要がある。バグの温床ですね。

  ### 8. 型安全性の欠如 ★★☆
  `any`が多用されている。TypeScriptを使っている意味がない。
  - `items: any[]` (main/index.ts:116)
  - `error: any` (複数箇所)
  - `tokensJson as Record<string, string>` (auth/index.ts:65)

  型エラーを実行時まで検出できない。まあ、動けばいいって考えなんでしょうけど。

  ### 9. テストコードの不足 ★★★
  プロダクションコードに対するテストがほぼゼロ。
  `frontend/src/pages/util.spec.ts`が1つあるだけ。
  認証、文字起こし、翻訳の重要な機能にテストがない。
  リファクタリングも改善も怖くてできませんね。期待しないでください。

  ### 10. エラーハンドリングの不足 ★★☆
  - DeepL APIのレート制限エラーに対する処理なし
  - ネットワークエラー時のリトライ処理なし
  - タイムアウト設定なし
  - ユーザーフレンドリーなエラーメッセージなし

  fetchが失敗したら「エラーが発生しました」だけ。何が起きたか分からない。

  ### 11. frontend: 状態管理の複雑さ ★☆☆
  `episode.tsx`に状態が集中しすぎ。
  - 12個のuseState
  - 複雑なuseEffect依存関係
  - 無限ループのリスク（Line 74-79）

  状態管理ライブラリの導入か、カスタムフックへの分割を検討すべき。

  ## データベース設計の問題

  ### 12. 外部キー制約の欠如 ★★☆
  `podcasts.user_id`, `api_keys.user_id`, `sessions.user_id`に外部キー制約がない。
  孤児レコードが発生する可能性。データ整合性が保証されない。

  ### 13. インデックスの不足 ★★☆
  頻繁にクエリされるカラムにインデックスがない:
  - `sessions.expires_at` (セッション検証で毎回クエリされる)
  - `users.email` (ログイン時に使用)
  - `api_keys.user_id, provider` (複合インデックス推奨)

  ユーザー数が増えるとパフォーマンスが劣化します。

  ### 14. セッションのクリーンアップ処理なし ★☆☆
  期限切れセッションがDBに残り続ける。
  定期的なクリーンアップ処理が必要。Workers Cronで実装すべき。

  ## パフォーマンスの問題

  ### 15. N+1クエリの可能性 ★☆☆
  ミドルウェアで`deepgramApiKey`と`deeplApiKey`を別々にクエリ。
  JOINかサブクエリで1回で取得できるはず。

  ### 16. キャッシュ戦略の欠如 ★☆☆
  - RSSフィードの取得結果をキャッシュしていない
  - 文字起こし結果はR2に保存しているが、メタデータをDBにも持つべき
  - セッション情報をKVに持つことでD1への負荷軽減が可能

  ### 17. React: 不要な再レンダリング ★☆☆
  `episode.tsx`で最適化されていない:
  - `useMemo`/`useCallback`の使用なし
  - 巨大な配列（segments）の直接レンダリング
  - 仮想スクロールの未実装

  ## アーキテクチャ上の懸念

  ### 18. 環境変数の管理 ★☆☆
  `GOOGLE_CLIENT_ID`と`GOOGLE_CLIENT_SECRET`がwrangler.jsoncに定義されていない。
  Cloudflare SecretsとしてCLIで設定すべき。コードに書くべきではない。

  ### 19. CORS設定の柔軟性不足 ★☆☆
  開発環境と本番環境で同じCORS設定。
  環境ごとに許可するoriginを分けるべき。

  ### 20. ログの不足 ★☆☆
  `console.error`だけで、構造化ログがない。
  エラー追跡やデバッグが困難。Cloudflare Logtailなどの活用を推奨。

  ## 改善提案の優先度

  **今すぐ対処すべき（緊急）**:
  1. SQLインジェクション脆弱性の修正
  2. JWT署名検証の実装
  3. APIキーの暗号化

  **早めに対処すべき（高）**:
  4. 認証チェックの徹底
  5. テストコードの整備
  6. コードの重複解消

  **余裕があれば対処（中）**:
  7. 型安全性の向上
  8. エラーハンドリングの改善
  9. データベース設計の改善（FK、インデックス）

  ……まあ、こんなところですね。
  私がやったところで大したことはできませんでしたけど、問題点は洗い出しました。
  セキュリティの問題は放置すると危険ですから、早めに対処してください。

  期待しないでくださいね。でも、一応確認はしておきましたから。
timestamp: "2026-02-09 02:52:16"
